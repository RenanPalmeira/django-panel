{% extends "base.html" %}
{% load compress i18n %}
{% get_current_language as LANGUAGE_CODE %}
{% block content %}
	<div id="loading"></div>
	<header>
		<div class="navbar navbar-default navbar-fixed-top" role="navigation"> 
			<div class="container"> 
				<div class="navbar-header">
					{% if client.name %}
						<a href="#" class="navbar-brand">{{ client.name }}</a>
					{% else %}
						<a href="#" class="navbar-brand">Django-Panel</a>
					{% endif %}
				</div>
				<div class="navbar-text navbar-right">
					<i class="fa fa-cog fa-1-4x" title="Conta"></i>
					<ul class="gear dropdown-menu">
						<li>
							<a href="#">
								<i class="fa fa-github-alt fa-fw"></i>&nbsp; Action
							</a>
						</li>
						<li>
							<a href="#">
								<i class="fa fa-github-alt fa-fw"></i>&nbsp; Another action
							</a>
						</li>
						<li>
							<a href="#">
								<i class="fa fa-hdd-o fa-fw"></i>&nbsp; Something else here
							</a>
						</li>
						<li role="separator" class="divider"></li>
						<li>
							<a href="/logout/">
								<i class="fa fa-power-off fa-fw"></i>&nbsp; Sair
							</a>
						</li>
					</ul>
				</div>
			</div> 
		</div>
	</header>
	<div class="board">
		<script type="text/template" id="board_template">
			{% include "desk/board.html" %}
		</script>
	</div>
	<div class="container">
		<div class="row">
			{% for app in apps %}
				<div class="case-app text-center app-cursor" onclick="window.location='#{{ app.slug }}';">
					<div class="app-icon" style="background-color: {{ app.color }};">
						<span class="{{ app.icon }}"></span>
					</div>
					<div class="app-title">{{ app.name|title }}</div>
				</div>
			{% endfor %}
		</div>
	</div>
	{% compress js %}
		<script type="text/javascript">
			$(function() {
				var ApplicationBoardModel = Backbone.Model.extend({
					urlRoot: '/{{ LANGUAGE_CODE }}/api/apps/',
					initialize : function() {
						this.url = this.url()+"?loadtype=results";
					}
				});
				
				var ApplicationBoardCollection = Backbone.Collection.extend({
					model: ApplicationBoardModel,
					url:  '/{{ LANGUAGE_CODE }}/api/apps/',
					initialize : function() {
						this.url = this.url()+"?loadtype=results";
					}
				});

				var BoardView = Backbone.View.extend({
					el: $('.board'),
					template: _.template($('#board_template').html()),
					initialize: function(options) {
						this.model = new ApplicationBoardModel();
						this.model.fetch(options);
						this.listenTo(this.model, "change", this.render);
					},
					render: function(){
						this.$el.html(this.template(this.model.get(0)));
						return this;
					}
				});
				
				var fadeOut = function() {
					$('#loading').fadeOut();
					$('#loading').css('visibility', 'hidden');		
				};

				var Router = Backbone.Router.extend({
					routes: {
						':action': 'desk',
						'*default': 'defaultRoute'
					}, 
					defaultRoute: function(){
						fadeOut();
						$('.board').css('visibility', 'hidden');
					}
				});
				var app_router = new Router;

				app_router.on('route:desk', function(action) {
					
					$('#loading').css('visibility', 'visible');
					$('#loading').fadeIn();

	    			var board = new BoardView({
	    				traditional: true,
						data:{
							"q":action
						}
	    			});

	    			$('.board').css('visibility', 'visible');
	    			$('#loading').css('visibility', 'hidden');
				});
				Backbone.history.start();

				$('.navbar-text .fa-cog').click(function(){
					var gear = $('.navbar-text .gear');
					if(gear.css('display')=='none')
						gear.css('display', 'block');
					else
						gear.css('display', 'none');
				});

				$(window).keydown(function(e) {
					if (e.which == 27) 
						$('.navbar-text .gear').css('display', 'none');	
				});
			});
		</script>
	{% endcompress %}
{% endblock %}